#!/bin/bash

set -eo pipefail

THING_NAME="${1:?"You need to specify a thing name"}"
PRIVATE_KEY_FILE=/certificates/${THING_NAME}.key.pem
PUBLIC_KEY_FILE=/certificates/${THING_NAME}.pub.pem
CERT_FILE=/certificates/${THING_NAME}.cert.pem

echo "Generating a new certificate"
PRINCIPAL="$(aws iot create-keys-and-certificate \
  --set-as-active \
  --certificate-pem-outfile ${CERT_FILE} \
  --public-key-outfile ${PUBLIC_KEY_FILE} \
  --private-key-outfile ${PRIVATE_KEY_FILE} | jq -r .certificateArn -)"

echo "Attaching certificate to thing"
aws iot attach-thing-principal \
  --thing-name ${THING_NAME} \
  --principal ${PRINCIPAL}
