{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Resources": {
    "ConnectPolicy": {
      "Type": "AWS::IoT::Policy",
      "Properties": {
        "PolicyDocument": {
          "Version": "2012-10-17",
          "Statement": {
            "Effect": "Allow",
            "Action": [
              "iot:Connect"
            ],
            "Resource": "*"
          }
        }
      }
    },
    "PublishPolicy": {
      "Type": "AWS::IoT::Policy",
      "Properties": {
        "PolicyDocument": {
          "Version": "2012-10-17",
          "Statement": {
            "Effect": "Allow",
            "Action": [
              "iot:Publish"
            ],
            "Resource": "*"
          }
        }
      }
    },
    "ReceivePolicy": {
      "Type": "AWS::IoT::Policy",
      "Properties": {
        "PolicyDocument": {
          "Version": "2012-10-17",
          "Statement": {
            "Effect": "Allow",
            "Action": [
              "iot:Receive"
            ],
            "Resource": "*"
          }
        }
      }
    },
    "SubscribePolicy": {
      "Type": "AWS::IoT::Policy",
      "Properties": {
        "PolicyDocument": {
          "Version": "2012-10-17",
          "Statement": {
            "Effect": "Allow",
            "Action": [
              "iot:Subscribe"
            ],
            "Resource": "*"
          }
        }
      }
    },
    "TempSensor01PublishPolicy": {
      "Type": "AWS::IoT::Policy",
      "Properties": {
        "PolicyDocument": {
          "Version": "2012-10-17",
          "Statement": {
            "Effect": "Allow",
            "Action": [
              "iot:Publish",
              "iot:UpdateThingShadow",
              "iot:DeleteThingShadow"
            ],
            "Resource": [
              {
                "Fn::Join": [
                  "",
                  [
                    "arn:",
                    {
                      "Ref": "AWS::Partition"
                    },
                    ":iot:",
                    {
                      "Ref": "AWS::Region"
                    },
                    ":",
                    {
                      "Ref": "AWS::AccountId"
                    },
                    ":topic/$aws/things/iot-TempSensor01/shadow/update"
                  ]
                ]
              },
              {
                "Fn::Join": [
                  "",
                  [
                    "arn:",
                    {
                      "Ref": "AWS::Partition"
                    },
                    ":iot:",
                    {
                      "Ref": "AWS::Region"
                    },
                    ":",
                    {
                      "Ref": "AWS::AccountId"
                    },
                    ":topic/$aws/things/iot-TempSensor01/shadow/delete"
                  ]
                ]
              }
            ]
          }
        }
      }
    },
    "TempSensor01SubscribePolicy": {
      "Type": "AWS::IoT::Policy",
      "Properties": {
        "PolicyDocument": {
          "Version": "2012-10-17",
          "Statement": {
            "Effect": "Allow",
            "Action": [
              "iot:Subscribe",
              "iot:Receive",
              "iot:GetThingShadow"
            ],
            "Resource": [
              {
                "Fn::Join": [
                  "",
                  [
                    "arn:",
                    {
                      "Ref": "AWS::Partition"
                    },
                    ":iot:",
                    {
                      "Ref": "AWS::Region"
                    },
                    ":",
                    {
                      "Ref": "AWS::AccountId"
                    },
                    ":topicfilter/$aws/things/iot-TempSensor01/shadow/update/accepted"
                  ]
                ]
              },
              {
                "Fn::Join": [
                  "",
                  [
                    "arn:",
                    {
                      "Ref": "AWS::Partition"
                    },
                    ":iot:",
                    {
                      "Ref": "AWS::Region"
                    },
                    ":",
                    {
                      "Ref": "AWS::AccountId"
                    },
                    ":topicfilter/$aws/things/iot-TempSensor01/shadow/update/rejected"
                  ]
                ]
              },
              {
                "Fn::Join": [
                  "",
                  [
                    "arn:",
                    {
                      "Ref": "AWS::Partition"
                    },
                    ":iot:",
                    {
                      "Ref": "AWS::Region"
                    },
                    ":",
                    {
                      "Ref": "AWS::AccountId"
                    },
                    ":topicfilter/$aws/things/iot-TempSensor01/shadow/delete/accepted"
                  ]
                ]
              },
              {
                "Fn::Join": [
                  "",
                  [
                    "arn:",
                    {
                      "Ref": "AWS::Partition"
                    },
                    ":iot:",
                    {
                      "Ref": "AWS::Region"
                    },
                    ":",
                    {
                      "Ref": "AWS::AccountId"
                    },
                    ":topicfilter/$aws/things/iot-TempSensor01/shadow/delete/rejected"
                  ]
                ]
              }
            ]
          }
        }
      }
    },
    "TempSensor01Certificate": {
      "Type": "AWS::IoT::Certificate",
      "Properties": {
        "CertificateSigningRequest": {
          "Ref": "TempSensor01CertificateSigningRequest"
        },
        "Status": "ACTIVE"
      }
    },
    "TempSensor01CertificateAttach": {
      "Type": "AWS::IoT::ThingPrincipalAttachment",
      "Properties": {
        "ThingName": {
          "Ref": "TempSensor01"
        },
        "Principal": {
          "Fn::Join": [
            "",
            [
              "arn:",
              {
                "Ref": "AWS::Partition"
              },
              ":iot:",
              {
                "Ref": "AWS::Region"
              },
              ":",
              {
                "Ref": "AWS::AccountId"
              },
              ":cert/",
              {
                "Ref": "TempSensor01Certificate"
              }
            ]
          ]
        }
      }
    },
    "TempSensor01ConnectPolicyAttach": {
      "Type": "AWS::IoT::PolicyPrincipalAttachment",
      "Properties": {
        "PolicyName": {
          "Ref": "ConnectPolicy"
        },
        "Principal": {
          "Fn::Join": [
            "",
            [
              "arn:",
              {
                "Ref": "AWS::Partition"
              },
              ":iot:",
              {
                "Ref": "AWS::Region"
              },
              ":",
              {
                "Ref": "AWS::AccountId"
              },
              ":cert/",
              {
                "Ref": "TempSensor01Certificate"
              }
            ]
          ]
        }
      }
    },
    "TempSensor01PublishPolicyAttach": {
      "Type": "AWS::IoT::PolicyPrincipalAttachment",
      "Properties": {
        "PolicyName": {
          "Ref": "TempSensor01PublishPolicy"
        },
        "Principal": {
          "Fn::Join": [
            "",
            [
              "arn:",
              {
                "Ref": "AWS::Partition"
              },
              ":iot:",
              {
                "Ref": "AWS::Region"
              },
              ":",
              {
                "Ref": "AWS::AccountId"
              },
              ":cert/",
              {
                "Ref": "TempSensor01Certificate"
              }
            ]
          ]
        }
      }
    },
    "TempSensor01SubscribePolicyAttach": {
      "Type": "AWS::IoT::PolicyPrincipalAttachment",
      "Properties": {
        "PolicyName": {
          "Ref": "TempSensor01SubscribePolicy"
        },
        "Principal": {
          "Fn::Join": [
            "",
            [
              "arn:",
              {
                "Ref": "AWS::Partition"
              },
              ":iot:",
              {
                "Ref": "AWS::Region"
              },
              ":",
              {
                "Ref": "AWS::AccountId"
              },
              ":cert/",
              {
                "Ref": "TempSensor01Certificate"
              }
            ]
          ]
        }
      }
    },
    "TempSensor01": {
      "Type": "AWS::IoT::Thing",
      "Properties": {
        "ThingName": {
          "Fn::Join": [
            "",
            [
              {
                "Ref": "AWS::StackName"
              },
              "-TempSensor01"
            ]
          ]
        }
      }
    }
  },
  "Parameters": {
    "TempSensor01CertificateSigningRequest": {
      "Type": "String",
      "Description": "Certificate Signing Request for the Bedroom Light",
      "Default": "-----BEGIN CERTIFICATE REQUEST-----\nMIIC1jCCAb4CAQAwgZAxCzAJBgNVBAYTAkFVMREwDwYDVQQIDAhWaWN0b3JpYTES\nMBAGA1UEBwwJTWVsYm91cm5lMR0wGwYDVQQKDBRNYWRQaWxvdCBQcm9kdWN0aW9u\nczEVMBMGA1UEAwwMVGVtcFNlbnNvcjAxMSQwIgYJKoZIhvcNAQkBFhVteWxlc0Bt\nYWRwaWxvdC5jb20uYXUwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQDa\nnylq2ggA5+rxLPRcYkyHClIiWB6pOJDuEWLdmpFOFivW6VANoO4ep21/xpCF9W7J\nLKx4eZ8r4Nq+fP/jQ/MZ71Cr80TY/rX2mVDaMDGteMQj2Sv7sSnDqpRqcJK7SKjX\n3soetCh21v+CrF9VgVBsRCFyN6VWdy8FVRzh/I6tq8IdaVuVDFFawenDEqiYr7Of\nmJkltSbocVTgunHCXog3sgsgrx83nzxvt21/9uAgGl/hhSleoQyi0TicezgIYJnO\nvE2ZwplMcTzxCIKWh/p4xIUN4qdCmMMXlXwQhrpySUKRFLw8tpNuFiCI2OWHxEig\nW8QsQSG4x15juTPh8VexAgMBAAGgADANBgkqhkiG9w0BAQsFAAOCAQEAKel86Psj\njem3bFUZMOXA3cQchpS6VLkcBX4YkfeWA7RhLptlA/RUJQ1DR/tX9f+J16a7pA39\n3xrsa6qUufAq52pWJexZYsEgFGOp9shr3jadRr44DtkoaXue7n8PVwTjxkLfgsy+\noGnEuoHNCNBHQdAqZpthlt1NdxgC+O/dQN7QMx2XzAPWzOPai2o52Bjp45AC3nwo\ntZixzj2Ygy5+4nedrqDDe/2KFf9sABmJnPprzfO9mbmyH/qUG2L6mO8P+vZZ0mCx\nxw/T68NGNrhnMkDtrVhyjRJAppwnJBNSe1f6ML0rA04GlZuAcyzNYDNc8eFVnOMF\ngkBu1Jqgig/9pA==\n-----END CERTIFICATE REQUEST-----\n"
    }
  }
}
