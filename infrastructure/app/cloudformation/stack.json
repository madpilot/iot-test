{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Resources": {
    "ConnectPolicy": {
      "Type": "AWS::IoT::Policy",
      "Properties": {
        "PolicyDocument": {
          "Version": "2012-10-17",
          "Statement": {
            "Effect": "Allow",
            "Action": [
              "iot:Connect"
            ],
            "Resource": "*"
          }
        }
      }
    },
    "PublishPolicy": {
      "Type": "AWS::IoT::Policy",
      "Properties": {
        "PolicyDocument": {
          "Version": "2012-10-17",
          "Statement": {
            "Effect": "Allow",
            "Action": [
              "iot:Publish"
            ],
            "Resource": "*"
          }
        }
      }
    },
    "ReceivePolicy": {
      "Type": "AWS::IoT::Policy",
      "Properties": {
        "PolicyDocument": {
          "Version": "2012-10-17",
          "Statement": {
            "Effect": "Allow",
            "Action": [
              "iot:Receive"
            ],
            "Resource": "*"
          }
        }
      }
    },
    "SubscribePolicy": {
      "Type": "AWS::IoT::Policy",
      "Properties": {
        "PolicyDocument": {
          "Version": "2012-10-17",
          "Statement": {
            "Effect": "Allow",
            "Action": [
              "iot:Subscribe"
            ],
            "Resource": "*"
          }
        }
      }
    },
    "ControllerSubscribePolicy": {
      "Type": "AWS::IoT::Policy",
      "Properties": {
        "PolicyDocument": {
          "Version": "2012-10-17",
          "Statement": {
            "Effect": "Allow",
            "Action": [
              "iot:Subscribe",
              "iot:Receive",
              "iot:GetThingShadow"
            ],
            "Resource": [
              {
                "Fn::Join": [
                  "",
                  [
                    "arn:",
                    {
                      "Ref": "AWS::Partition"
                    },
                    ":iot:",
                    {
                      "Ref": "AWS::Region"
                    },
                    ":",
                    {
                      "Ref": "AWS::AccountId"
                    },
                    ":topicfilter/$aws/things/iot-TempSensor01/shadow/update"
                  ]
                ]
              },
              {
                "Fn::Join": [
                  "",
                  [
                    "arn:",
                    {
                      "Ref": "AWS::Partition"
                    },
                    ":iot:",
                    {
                      "Ref": "AWS::Region"
                    },
                    ":",
                    {
                      "Ref": "AWS::AccountId"
                    },
                    ":topicfilter/$aws/things/iot-TempSensor01/shadow/update/accepted"
                  ]
                ]
              },
              {
                "Fn::Join": [
                  "",
                  [
                    "arn:",
                    {
                      "Ref": "AWS::Partition"
                    },
                    ":iot:",
                    {
                      "Ref": "AWS::Region"
                    },
                    ":",
                    {
                      "Ref": "AWS::AccountId"
                    },
                    ":topicfilter/$aws/things/iot-TempSensor01/shadow/update/document"
                  ]
                ]
              },
              {
                "Fn::Join": [
                  "",
                  [
                    "arn:",
                    {
                      "Ref": "AWS::Partition"
                    },
                    ":iot:",
                    {
                      "Ref": "AWS::Region"
                    },
                    ":",
                    {
                      "Ref": "AWS::AccountId"
                    },
                    ":topicfilter/$aws/things/iot-TempSensor01/shadow/update/delta"
                  ]
                ]
              }
            ]
          }
        }
      }
    },
    "ControllerCertificate": {
      "Type": "AWS::IoT::Certificate",
      "Properties": {
        "CertificateSigningRequest": {
          "Ref": "ControllerCertificateSigningRequest"
        },
        "Status": "ACTIVE"
      }
    },
    "ControllerCertificateAttach": {
      "Type": "AWS::IoT::ThingPrincipalAttachment",
      "Properties": {
        "ThingName": {
          "Ref": "Controller"
        },
        "Principal": {
          "Fn::Join": [
            "",
            [
              "arn:",
              {
                "Ref": "AWS::Partition"
              },
              ":iot:",
              {
                "Ref": "AWS::Region"
              },
              ":",
              {
                "Ref": "AWS::AccountId"
              },
              ":cert/",
              {
                "Ref": "ControllerCertificate"
              }
            ]
          ]
        }
      }
    },
    "ControllerConnectPolicyAttach": {
      "Type": "AWS::IoT::PolicyPrincipalAttachment",
      "Properties": {
        "PolicyName": {
          "Ref": "ConnectPolicy"
        },
        "Principal": {
          "Fn::Join": [
            "",
            [
              "arn:",
              {
                "Ref": "AWS::Partition"
              },
              ":iot:",
              {
                "Ref": "AWS::Region"
              },
              ":",
              {
                "Ref": "AWS::AccountId"
              },
              ":cert/",
              {
                "Ref": "ControllerCertificate"
              }
            ]
          ]
        }
      }
    },
    "ControllerSubscribePolicyAttach": {
      "Type": "AWS::IoT::PolicyPrincipalAttachment",
      "Properties": {
        "PolicyName": {
          "Ref": "ControllerSubscribePolicy"
        },
        "Principal": {
          "Fn::Join": [
            "",
            [
              "arn:",
              {
                "Ref": "AWS::Partition"
              },
              ":iot:",
              {
                "Ref": "AWS::Region"
              },
              ":",
              {
                "Ref": "AWS::AccountId"
              },
              ":cert/",
              {
                "Ref": "ControllerCertificate"
              }
            ]
          ]
        }
      }
    },
    "TempSensor01PublishPolicy": {
      "Type": "AWS::IoT::Policy",
      "Properties": {
        "PolicyDocument": {
          "Version": "2012-10-17",
          "Statement": {
            "Effect": "Allow",
            "Action": [
              "iot:Publish",
              "iot:UpdateThingShadow",
              "iot:DeleteThingShadow"
            ],
            "Resource": [
              {
                "Fn::Join": [
                  "",
                  [
                    "arn:",
                    {
                      "Ref": "AWS::Partition"
                    },
                    ":iot:",
                    {
                      "Ref": "AWS::Region"
                    },
                    ":",
                    {
                      "Ref": "AWS::AccountId"
                    },
                    ":topic/$aws/things/iot-TempSensor01/shadow/update"
                  ]
                ]
              },
              {
                "Fn::Join": [
                  "",
                  [
                    "arn:",
                    {
                      "Ref": "AWS::Partition"
                    },
                    ":iot:",
                    {
                      "Ref": "AWS::Region"
                    },
                    ":",
                    {
                      "Ref": "AWS::AccountId"
                    },
                    ":topic/$aws/things/iot-TempSensor01/shadow/delete"
                  ]
                ]
              }
            ]
          }
        }
      }
    },
    "TempSensor01SubscribePolicy": {
      "Type": "AWS::IoT::Policy",
      "Properties": {
        "PolicyDocument": {
          "Version": "2012-10-17",
          "Statement": {
            "Effect": "Allow",
            "Action": [
              "iot:Subscribe",
              "iot:Receive",
              "iot:GetThingShadow"
            ],
            "Resource": [
              {
                "Fn::Join": [
                  "",
                  [
                    "arn:",
                    {
                      "Ref": "AWS::Partition"
                    },
                    ":iot:",
                    {
                      "Ref": "AWS::Region"
                    },
                    ":",
                    {
                      "Ref": "AWS::AccountId"
                    },
                    ":topicfilter/$aws/things/iot-TempSensor01/shadow/update/accepted"
                  ]
                ]
              },
              {
                "Fn::Join": [
                  "",
                  [
                    "arn:",
                    {
                      "Ref": "AWS::Partition"
                    },
                    ":iot:",
                    {
                      "Ref": "AWS::Region"
                    },
                    ":",
                    {
                      "Ref": "AWS::AccountId"
                    },
                    ":topicfilter/$aws/things/iot-TempSensor01/shadow/update/rejected"
                  ]
                ]
              },
              {
                "Fn::Join": [
                  "",
                  [
                    "arn:",
                    {
                      "Ref": "AWS::Partition"
                    },
                    ":iot:",
                    {
                      "Ref": "AWS::Region"
                    },
                    ":",
                    {
                      "Ref": "AWS::AccountId"
                    },
                    ":topicfilter/$aws/things/iot-TempSensor01/shadow/delete/accepted"
                  ]
                ]
              },
              {
                "Fn::Join": [
                  "",
                  [
                    "arn:",
                    {
                      "Ref": "AWS::Partition"
                    },
                    ":iot:",
                    {
                      "Ref": "AWS::Region"
                    },
                    ":",
                    {
                      "Ref": "AWS::AccountId"
                    },
                    ":topicfilter/$aws/things/iot-TempSensor01/shadow/delete/rejected"
                  ]
                ]
              }
            ]
          }
        }
      }
    },
    "TempSensor01Certificate": {
      "Type": "AWS::IoT::Certificate",
      "Properties": {
        "CertificateSigningRequest": {
          "Ref": "TempSensor01CertificateSigningRequest"
        },
        "Status": "ACTIVE"
      }
    },
    "TempSensor01CertificateAttach": {
      "Type": "AWS::IoT::ThingPrincipalAttachment",
      "Properties": {
        "ThingName": {
          "Ref": "TempSensor01"
        },
        "Principal": {
          "Fn::Join": [
            "",
            [
              "arn:",
              {
                "Ref": "AWS::Partition"
              },
              ":iot:",
              {
                "Ref": "AWS::Region"
              },
              ":",
              {
                "Ref": "AWS::AccountId"
              },
              ":cert/",
              {
                "Ref": "TempSensor01Certificate"
              }
            ]
          ]
        }
      }
    },
    "TempSensor01ConnectPolicyAttach": {
      "Type": "AWS::IoT::PolicyPrincipalAttachment",
      "Properties": {
        "PolicyName": {
          "Ref": "ConnectPolicy"
        },
        "Principal": {
          "Fn::Join": [
            "",
            [
              "arn:",
              {
                "Ref": "AWS::Partition"
              },
              ":iot:",
              {
                "Ref": "AWS::Region"
              },
              ":",
              {
                "Ref": "AWS::AccountId"
              },
              ":cert/",
              {
                "Ref": "TempSensor01Certificate"
              }
            ]
          ]
        }
      }
    },
    "TempSensor01PublishPolicyAttach": {
      "Type": "AWS::IoT::PolicyPrincipalAttachment",
      "Properties": {
        "PolicyName": {
          "Ref": "TempSensor01PublishPolicy"
        },
        "Principal": {
          "Fn::Join": [
            "",
            [
              "arn:",
              {
                "Ref": "AWS::Partition"
              },
              ":iot:",
              {
                "Ref": "AWS::Region"
              },
              ":",
              {
                "Ref": "AWS::AccountId"
              },
              ":cert/",
              {
                "Ref": "TempSensor01Certificate"
              }
            ]
          ]
        }
      }
    },
    "TempSensor01SubscribePolicyAttach": {
      "Type": "AWS::IoT::PolicyPrincipalAttachment",
      "Properties": {
        "PolicyName": {
          "Ref": "TempSensor01SubscribePolicy"
        },
        "Principal": {
          "Fn::Join": [
            "",
            [
              "arn:",
              {
                "Ref": "AWS::Partition"
              },
              ":iot:",
              {
                "Ref": "AWS::Region"
              },
              ":",
              {
                "Ref": "AWS::AccountId"
              },
              ":cert/",
              {
                "Ref": "TempSensor01Certificate"
              }
            ]
          ]
        }
      }
    },
    "Controller": {
      "Type": "AWS::IoT::Thing",
      "Properties": {
        "ThingName": {
          "Fn::Join": [
            "",
            [
              {
                "Ref": "AWS::StackName"
              },
              "-Controller"
            ]
          ]
        }
      }
    },
    "TempSensor01": {
      "Type": "AWS::IoT::Thing",
      "Properties": {
        "ThingName": {
          "Fn::Join": [
            "",
            [
              {
                "Ref": "AWS::StackName"
              },
              "-TempSensor01"
            ]
          ]
        }
      }
    }
  },
  "Parameters": {
    "ControllerCertificateSigningRequest": {
      "Type": "String",
      "Description": "Certificate Signing Request for the Controller",
      "Default": "-----BEGIN CERTIFICATE REQUEST-----\nMIIC1DCCAbwCAQAwgY4xCzAJBgNVBAYTAkFVMREwDwYDVQQIDAhWaWN0b3JpYTES\nMBAGA1UEBwwJTWVsYm91cm5lMR0wGwYDVQQKDBRNYWRQaWxvdCBQcm9kdWN0aW9u\nczETMBEGA1UEAwwKQ29udHJvbGxlcjEkMCIGCSqGSIb3DQEJARYVbXlsZXNAbWFk\ncGlsb3QuY29tLmF1MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAsp4g\ntKT0OsgA+d1IivdrgUux6hfRmlNJfCEpClusnqSd2NfjhCUlxl+vBfdViDiMIcK0\nPihpSrwKvnZ12+IF+DfiM+8y+PwI578c5Z7JWIRIxXHJhdhMYukLowDYjFPkQwrd\n761qc5hlETFlD9gqXCmGglvLrNuDFBx7ptxdzPBnwdoa1VcdXBROS7CIlCv6lsWH\nQIpwfoH2ze4NhnO/4PdIWPdvrwuNVsySdE2YcO7XpRHz1OOYre5sAg3hPETPy7YO\nmA8fAI2BCMNo2qfPA+7LsQynkimnLjKAW7C5AMricKjxH3ibCWUoCnR2ADVx6C8m\n/0o/ZfOp2QKAboiRBQIDAQABoAAwDQYJKoZIhvcNAQELBQADggEBAGUKDAPkk0ov\niJ8jOdp+3Ordh/1ED/AOWVQ+h3fGiwCFfNYH7JC3zavC9tuFgVsGxE6pr5njAfQl\nJ8YU7OtY19HKTtjx7/4cW5KsQ9Cr1rD75EUVnjcvQ08bT4KahxJBUrS5qOrpek6P\nnCvZss32hgmK+CiVQGykJrd4x5n36raj5z9sUR3ZYnEhaq3tMCrcsFToc2dLN4Bg\nXB5+Nmj+TS6yDRm5SoZr+rp/oVyFicuFKbNW1jS57ONmi/mT4RHSgYTeapAkmiQy\n0/TpH9Eoz5pLLMY3rA/AoENu4N52ABAr3Qa7Yo7zutXOrj61Vgkbn35tkWy+17f+\nRrtvCIybgec=\n-----END CERTIFICATE REQUEST-----\n"
    },
    "TempSensor01CertificateSigningRequest": {
      "Type": "String",
      "Description": "Certificate Signing Request for the Temperature Sensor",
      "Default": "-----BEGIN CERTIFICATE REQUEST-----\nMIIC1jCCAb4CAQAwgZAxCzAJBgNVBAYTAkFVMREwDwYDVQQIDAhWaWN0b3JpYTES\nMBAGA1UEBwwJTWVsYm91cm5lMR0wGwYDVQQKDBRNYWRQaWxvdCBQcm9kdWN0aW9u\nczEVMBMGA1UEAwwMVGVtcFNlbnNvcjAxMSQwIgYJKoZIhvcNAQkBFhVteWxlc0Bt\nYWRwaWxvdC5jb20uYXUwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQDa\nnylq2ggA5+rxLPRcYkyHClIiWB6pOJDuEWLdmpFOFivW6VANoO4ep21/xpCF9W7J\nLKx4eZ8r4Nq+fP/jQ/MZ71Cr80TY/rX2mVDaMDGteMQj2Sv7sSnDqpRqcJK7SKjX\n3soetCh21v+CrF9VgVBsRCFyN6VWdy8FVRzh/I6tq8IdaVuVDFFawenDEqiYr7Of\nmJkltSbocVTgunHCXog3sgsgrx83nzxvt21/9uAgGl/hhSleoQyi0TicezgIYJnO\nvE2ZwplMcTzxCIKWh/p4xIUN4qdCmMMXlXwQhrpySUKRFLw8tpNuFiCI2OWHxEig\nW8QsQSG4x15juTPh8VexAgMBAAGgADANBgkqhkiG9w0BAQsFAAOCAQEAKel86Psj\njem3bFUZMOXA3cQchpS6VLkcBX4YkfeWA7RhLptlA/RUJQ1DR/tX9f+J16a7pA39\n3xrsa6qUufAq52pWJexZYsEgFGOp9shr3jadRr44DtkoaXue7n8PVwTjxkLfgsy+\noGnEuoHNCNBHQdAqZpthlt1NdxgC+O/dQN7QMx2XzAPWzOPai2o52Bjp45AC3nwo\ntZixzj2Ygy5+4nedrqDDe/2KFf9sABmJnPprzfO9mbmyH/qUG2L6mO8P+vZZ0mCx\nxw/T68NGNrhnMkDtrVhyjRJAppwnJBNSe1f6ML0rA04GlZuAcyzNYDNc8eFVnOMF\ngkBu1Jqgig/9pA==\n-----END CERTIFICATE REQUEST-----\n"
    }
  }
}
